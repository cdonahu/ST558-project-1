---
title: "COVID-19 API Vignette"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# My First Vignette  

This document is a vignette to describe how to read and summarize data from an API. I will demonstrate using a [COVID-19 API]{https://covid19api.com/}, because my attempts to work with the Pokemon API were unsuccessful. I will build a couple of functions to interact and explore the data we can retrieve from the API.   

To use a function that returns data at the country level, the user may either enter the country's name or its two-letter country code in the [ISO 3166]{https://www.iban.com/country-codes} format. 

## Requirements

I used the following packages in the creation of the vignette, and the user will need them to run the functions and interact with the COVID-19 API:  

- [`httr`]{https://httr.r-lib.org/}: I used this to access the API  
- [`jsonlite`]{https://cran.r-project.org/web/packages/jsonlite/index.html}: I used this to convert the Pokemon data to a dataframe    
- [`tidyverse`]{https://www.tidyverse.org/}: I used this set of packages for things like piping and plotting data visualizations  


To get started, install and load the packages listed above: 

```{r Install and Read in Packages, message=FALSE}
library(httr)
library(jsonlite)
library(tidyverse)
```


## Functions to Interact With the API

The COVID-19 API is simple because it does not require users to get a key and authenticate. This makes accessing it less complex than some other APIs. If you want, you can purchase different monthly subscription levels for more than just the basic authorization to the API. The premium subscriptions include more interesting data (population ages, GDP, diabetes rates, handwashing facilities, etc.) and no rate limit.  

### `countryCases`

I wrote a function `countryCases` for a user to interact with the `summary` endpoint of the Coronavirus COVID19 API. It returns a data frame with key metrics (cases, deaths, recoveries) for every country. It accepts one argument, `country`, and the default value is "all". The user may enter a country's name or its two character country code to get only data for a specific country.  


```{r countryCases function}
countryCases <- function(country="all"){
  ###
  # This function returns a data frame with data on Covid cases. It can also
  # return those columns for a single country if a country's name or abbreviation is passed.
  ###
  
  # Get the country data from the summaryRoute endpoint.
  outputAPI <- fromJSON(
    "https://api.covid19api.com/summary"
  )
  
  # Select only the Countries data from the JSON output.
  output <- outputAPI$Countries
  
  # If country does not equal "all", check if it is an abbrev or country name.
  if (country != "all"){
    
    # If country is in the CountryCode column, subset output for just that row.
    if (country %in% output$CountryCode){
      output <- output %>%
        filter(CountryCode == country)
    }
    # If country is in the Country column, subset output for just that row.
    else if (country %in% output$Country){
      output <- output %>%
        filter(Country == country)
    }
    # Otherwise, throw an informative error.
    else {
      message <- paste("ERROR: Argument for country was not found in either",
                       "the Country or CountryCode columns. Try ('all') to",
                       "find the country you're looking for.")
      stop(message)
    }
  }
  # Do nothing if the country value equals "all".
  else {
    
  }
  
 # Return the output data frame.
  return(output)
}
```

### `getSlug`  

I also wrote a helper function, `getSlug`, which finds the "slug", or the version of a country's name formatted for use within a URL. The user inputs a country's name or two-letter abbreviation, and `getSlug` returns the slug. This will help in other functions that interact with the COVID-19 API.  

```{r getSlug function}
# Function to get the slug for a given country name or abbreviation
getSlug <- function(country){
  
  # Get the country list from the Countries endpoint.
  output <- fromJSON("https://api.covid19api.com/countries")
  
  # If country is in the ISO2 column, subset output for just that row.
  if (country %in% output$ISO2){
    output <- output$Slug[output$ISO2 == country]
  }
  # If country is in the Country column, subset output for just that row.
  else if (country %in% output$Country){
    output <- output$Slug[output$Country == country]
  }
  # Otherwise, throw an informative error.
  else {
    message <- paste("ERROR: Argument for country was not found in either",
                     "the Country or CountryCode columns. Try ('all') to",
                     "find the country you're looking for.")
    stop(message)
  }
  # Return the slug.
  return(output)
}
```


### `dailyCases`  

I wrote a function to allow the user to select a country of interest and receive the daily confirmed case count for that country, as well as the country's location (latitude/longitude). The `dailyCases` function uses the helper function `getSlug` from above to retrieve the information. It returns cumulative confirmed cases starting with the first day a case was confirmed.   

```{r dailyCases function}
dailyCases <- function(country){
  ###
  # This function returns a data frame with data on number of confirmed Covid cases on each date in a user-selected country. 
  ###
  
  # find the "slug" based on the country the user selected
  slug <- getSlug(country)
  
  # Get the country data from the Day One Live endpoint.
  output <- fromJSON(paste(
    "https://api.covid19api.com/dayone/country/", slug, "/status/confirmed/live", sep = "")
  )
  
  # If country is in the CountryCode column, subset output for just that row.
  if (country %in% output$CountryCode){
    output <- output %>%
      filter(CountryCode == country)
  }
  # If country is in the Country column, subset output for just that row.
  else if (country %in% output$Country){
    output <- output %>%
      filter(Country == country)
  }
  # Otherwise, throw an informative error.
  else {
    message <- paste("ERROR: Argument for country was not found in either",
                       "the Country or CountryCode columns. Try ('all') to",
                       "find the country you're looking for.")
    stop(message)
  }

  # Return the output data frame.
  return(output)
}
```


### `plotCases`

Next, I wanted to create a function to plot the cases by date, so the user could get a visualization of the type of data they retrieve using my `dailyCases` function. The user inputs a country, and receives a labeled plot of cumulative confirmed cases in that country.  

```{r plotCases}

plotCases <- function(country){
  
  data <- dailyCases(country)
  
  # Convert date column from character into date class
  data$Date <- as.Date(data$Date)
  
  # Plot the data
  ggplot(data, aes(x = data$Date, y = data$Cases)) +
    geom_col() +
    ggtitle(paste("New Cases by Date in ", country, sep = "")) +
    xlab("Date") + ylab("New Cases")
}
```




– Your function(s) should allow the user to customize their query to return specific data.
– You do not need to allow the user to query all parts of the API but should allow for at least six modifications or endpoints, etc.
– The function(s) should be user friendly. That is, it should be easy to specify the options. For example, the ticker types for the financial API has options you can specify such as:
∗ ADR (American Depository Receipt)
∗ CEF (Closed-End Fund)
∗ CS (Common stock)
The user shouldn’t be required to use the abbreviation and should be able to use the quoted string for use-ability. (You’d want to give the user the option of specifying the abbreviation or the quoted string.
For the string, you may want to check the string after converting it to all lower-case and then map it to the abbreviation for querying).

```{r Functions to contact Pokemon API}

```


## Exploratory Data Analysis  

- You should pull data from at least two endpoints (possibly combining them into one)  
- You should create one (or more) relevant new variable that is a function of the variables from a data set you use  
- You should create some contingency tables  
- You should create numerical summaries for some quantitative variables at each setting of some of your categorical variables  
- You should create at least five plots utilizing coloring, grouping, etc. All plots should have nice labels and titles.  
- You should have at least one bar plot, one histogram, one box plot, and one scatter plot  





